# Basic organization

This section presents the structure of a basic RTFM program.

Below is shown a minimal RTFM program.

``` rust
#![feature(proc_macro)] // required to import the `app!` macro
#![no_std]

extern crate cortex_m_rtfm;
extern crate panic_abort; // panicking behavior
extern crate stm32f103xx; // device crate

use cortex_m_rtfm::app;

app! {
    device: stm32f103xx,
}

fn init(ctxt: init::Context) -> init::LateResources {
    // Cortex-M peripherals
    let core = ctxt.core;

    // device peripherals
    let device = ctxt.device;

    init::LateResources {} // more on this later
}

fn idle(ctxt: idle::Context) -> ! {
    loop {
        // do stuff here
    }
}
```

All RTFM applications include an invocation of the `app!` macro; this macro is the *specification*
of the application. At the very least you'll have to declare the device you are using in this macro.
I'll be using the STM32F103RB microcontroller throughout this book so I'll use `stm32f103xx` for the
value of the `device` field. The value of this field is the *path* to a device crate, a crate
generated using `svd2rust`.

The `app!` macro generates the entry point of the program: the `main` function. So, instead of a
`main` function you have to provide *two* functions: `idle` and `init`. The signatures of those two
functions are shown in the minimal example. The `main` function generated by the `app!` macro will
call the `init` function *with interrupts disabled* first and then it will call the never ending
`idle` function.

The arguments of the `init` and `idle` are these `Context` values. These `Context` structs have the
following fields:

``` rust
// generated by the `app!` macro
mod init {
    struct Context {
        // pretty similar to `cortex_m::Peripherals`, minus some fields
        pub core: CorePeripherals,
        pub device: stm32f103xx::Peripherals,
        pub resources: Resources,
        pub tasks: Tasks,
        pub threshold: Threshold,
    }

    // ..
}

// generated by the `app!` macro
mod idle {
    pub struct Context {
        pub resources: Resources,
        pub threshold: Threshold,
    }

    // ..
}
```

That covers the structure of a minimal RTFM application. RTFM applications are usually structured as
a set of *tasks*. In the next section we'll see how create tasks.
